<html>
<head>
    <title>Lifemapper</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Open%20Sans&display=swap" rel="stylesheet">
    <style type="text/css">
        canvas {
            padding: 8px;
            border: 1px solid #eee;
            border-radius: 6px;
            box-shadow: 0px 1px 2px #ddd;
        }
        html {
            font-family: "Open Sans", sans-serif;
            font-size: .9em;
            box-sizing: border-box;
        }
        *, *:before, *:after {
          box-sizing: inherit;
        }
        body {
            width: 100%;
            padding: 1em 1.2em;
        }
        h3 {
            margin-bottom: 0;
        }
        p {
            margin-top: .9em;
            width: 800px;
        }
        a {
            color: blue;
            cursor: pointer;
            text-decoration: underline;
        }
        textarea {
            width: 800px;
            height: 300px;
            padding: 14px;
            background-color: #eee;
            border-radius: 6px;
        }
        #main {
            width: 100%;
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
        }
            #canvas {
                margin: 0 1.5em 1.5em 0;
                flex-grow: 0;
            }
            the_big_form {
                min-width: 260px;
                flex-grow: 1;
                overflow: scroll;
            }
                .tabs-wrap {
                    margin-top: 1em;
                }
                    .tabs {
                        border-bottom: 1px solid #999;
                    }
                        .tab {
                            font-size: .9em;
                            margin: 0 .15em -1px;
                            border: 1px solid #999;
                            padding: .4em;
                            display: inline-block;
                        }
                            .tab.active {
                                border-bottom: 1px solid white;
                            }
                    .tabs-content {
                        padding-top: 1em;
                    }
                        .dimmed {
                            opacity: .6;
                        }
                .input_short {
                    width: 70px;
                }
        .footer {
            font-size: .8em;
        }
    </style>
</head>
<body>

    <h3>Lifemapper</h3>
    <hr style='margin-bottom:1em'>

    <div id='main'>
        <canvas id="canvas" width="750" height="100">
            <p>Looks like your browser doesn't support the features necessary to run this web app :'(</p>
        </canvas>
        <the_big_form></the_big_form>
    </div>

    <hr>
    <h3>Your lifemap code</h3>
    <p>Copy this code and save it somewhere (e.g. email it to yourself or save it on your computer) &mdash; it contains all the information necessary to recreate your lifemap. Paste it back in this box in the future in order to modify, add to, or re-generate your lifemap.</p>
    <data_codebox></data_codebox>

    <hr>
    <h3>Custom styling</h3>
    <p>The styling of your lifemap is also editable. If you change this from the default, save it as well.</p>
    <styles_codebox></styles_codebox>

    <hr>
    <p class='footer'>Lifemapper is a fully client-side application. Your lifemap data is never transmitted anywhere. If you are concerned about data privacy, you could disconnect your internet before inputting your data. Or, you could download a local copy of the web site (by cloning the <a href='https://github.com/rothos/lifemapper'>git repository</a>) and run it all locally.</p>

    <script src="lodash.js"></script>
    <script src="app.js"></script>
    <script type="coffee">
    # to do:
    # - undo button (accidental deletions are annoying)
    # - add a "clear all" button to reset all data
    # - add a "demo data" button to insert demo data
    # - sort button inside each tab, at top, for sorting entries
    # - sort entries by date/start_date before drawing the lifemap
    # - interface to select styles

    redraw = () ->
        data = fetch('data')
        styles = fetch('styles')
        clearCanvas()
        drawLifemap(data, styles)

    state.data = _.cloneDeep(empty_data)
    state.styles = _.cloneDeep(default_styles)

    dom.EDITABLE_INPUT = (path, classname='') ->
        data = fetch('data')
        INPUT
            className: classname
            value: _.get(data, path, "")
            onChange: (e) =>
                _.set(data, path, e.target.value)
                save(data)
                redraw()

    dom.EDITABLE_CHECKBOX = (path, classname='') ->
        data = fetch('data')
        INPUT
            type: "checkbox"
            checked: _.get(data, path, true)
            onChange: (e) =>
                _.set(data, path, !_.get(data, path, true))
                save(data)
                redraw()

    # we're always deleting a specific element from an array
    dom.DELETELINK = (path_to_array, index, text='delete', classname='') ->
        data = fetch('data')
        A
            className: classname
            onClick: (e) =>
                _.get(data, path_to_array).splice(index, 1)
                save(data)
                redraw()
            text

    dom.EVENTS_TAB_CONTENT = ->
        events = fetch('data').events
        DIV {},
            for k in [0..events.length]
                classname = if events[k] then '' else 'dimmed'
                DIV { className: classname },
                    'text: '
                    dom.EDITABLE_INPUT(['events', k, 'text'])
                    BR()
                    'date: '
                    dom.EDITABLE_INPUT(['events', k, 'date'])
                    if events[k]
                        DIV {},
                            dom.DELETELINK('events', k)
                    BR()

    dom.A_RIBBONS_TAB_CONTENT = (category) ->
        items = fetch('data').ribbons[category]
        DIV {},
            for k in [0..items.length]
                classname = if items[k] then '' else 'dimmed'
                DIV { className: classname },
                    'text: '
                    dom.EDITABLE_INPUT(['ribbons', category, k, 'text'])
                    BR()
                    'start date: '
                    dom.EDITABLE_INPUT(['ribbons', category, k, 'start_date'])
                    BR()
                    'end date: '
                    dom.EDITABLE_INPUT(['ribbons', category, k, 'end_date'])
                    if items[k]
                        DIV {},
                            dom.DELETELINK(['ribbons', category], k)
                    BR()

    dom.FORM_TABS = ->
        data = fetch('data')
        ribbon_categories = _.keys(data.ribbons)

        tab_names = _.concat(['events'], ribbon_categories)
        tab_fns = _.concat(
            [dom.EVENTS_TAB_CONTENT],
            _.map(ribbon_categories, (cat) -> (() -> dom.A_RIBBONS_TAB_CONTENT(cat)) )
        )

        ui = fetch('ui')

        if not ui.active_tab
            ui.active_tab = 0
            save(ui)

        DIV { className: 'tabs-wrap' },
            DIV { className: 'tabs' },
                for k in [0..tab_names.length-1]
                    name = tab_names[k]
                    active = if ui.active_tab is k then ' active' else ''

                    A
                        className: 'tab' + active
                        onClick: ((k) ->
                            ui.active_tab = k
                            save(ui)).bind(this, k)
                        name

            DIV { className: 'tabs-content' },
                tab_fns[ui.active_tab]()

    dom.THE_BIG_FORM = ->
        DIV {},
            DIV {},
                data = fetch('data')
                A
                    onClick: (e) =>
                        state.data = demo_data
                        save(data)
                        redraw()
                    'try demo data'
                ' . . . '
                A
                    onClick: (e) =>
                        state.data = empty_data
                        save(data)
                        redraw()
                    'clear all data'
                BR()
                BR()

            DIV {},
                'start year: '
                dom.EDITABLE_INPUT('start_year', 'input_short')
                BR()
                'end year: '
                dom.EDITABLE_INPUT('end_year', 'input_short')
                BR()
                'date of birth: '
                dom.EDITABLE_INPUT('date_of_birth')
                BR()
                'include birthdays? '
                dom.EDITABLE_CHECKBOX('include_birthdays')
                dom.FORM_TABS()

    dom.CODEBOX = (stateobj) ->
        TEXTAREA
            value: JSON.stringify(stateobj, null, 4)
            onChange: (e) =>
                stateobj = JSON.parse(e.target.value)
                save(stateobj)
                redraw()

    dom.DATA_CODEBOX = ->
        data = fetch('data')
        dom.CODEBOX(data)

    dom.STYLES_CODEBOX = ->
        styles = fetch('styles')
        dom.CODEBOX(styles)

    </script>
    <script src="https://stateb.us/client6.js"></script>
</body>
</html>
